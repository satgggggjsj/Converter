<script>
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  function convert() {
    const url = document.getElementById('url').value.trim();
    const format = document.getElementById('format').value;
    const result = document.getElementById('result');

    if (!url) {
      result.style.display = 'block';
      result.innerHTML = '<span class="err">‚ùå Iltimos, link kiriting</span>';
      return;
    }

    const platforms = ['youtube', 'youtu.be', 'instagram', 'tiktok'];
    const valid = platforms.some(p => url.includes(p));

    if (!valid) {
      result.style.display = 'block';
      result.innerHTML = '<span class="err">‚ùå Platforma qo‚Äòllab-quvvatlanmaydi</span>';
      return;
    }

    const user = tg.initDataUnsafe?.user;

    const payload = {
      url: url,
      format: format,
      user_id: user?.id,
      username: user?.username
    };

    // 1Ô∏è‚É£ Botga yuboramiz
    tg.sendData(JSON.stringify(payload));

    // 2Ô∏è‚É£ Yuklanmoqda chiqadi
    result.style.display = 'block';
    result.innerHTML = `
      ‚è≥ <b>Yuklanmoqda...</b><br><br>
      Bot faylni tayyorlayapti
    `;

    // 3Ô∏è‚É£ 1.5 soniyadan keyin "Ko‚Äòrish" tugmasi chiqadi
    setTimeout(() => {
      result.innerHTML = `
        <span class="ok">‚úÖ Fayl tayyor</span><br><br>
        <button onclick="openInBot()">üëÄ Ko‚Äòrish</button>
      `;
    }, 1500);
  }

  function openInBot() {
    // 4Ô∏è‚É£ Mini App yopiladi ‚Üí bot chatga qaytadi
    tg.close();
  }
</script>
